<html>
  <head>
    <title>Live Streaming</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{url_for('static', filename='css/style.css')}}"
    />
  </head>
  <body>
    <h2 id="title"><i>Bose Streaming App</i></h2>
    <nav id="navbar">
      <div class="containernav">
        <ul>
          <li><a href="#">Live Streaming</a></li>
          <li><a href="{{ url_for('ui') }}">Recorded Streaming</a></li>
        </ul>
      </div>
    </nav>

    <div class="containertext">
      <br />
      <button id="livebutton" onclick="goLive()">
        <img
          src="https://ak2.picdn.net/shutterstock/videos/5721572/thumb/9.jpg"
          height="120"
          width="200"
        />
      </button>
      <p>Click the button above to begin streaming!</p>
    </div>
    <!-- Container End -->
  </body>
  <script src="https://cdn.webrtc-experiment.com/MediaStreamRecorder.js"></script>
  <script src="{{url_for('static', filename='recorder.js')}}"></script>
  <script>

    // Expose globally your audio_context, the recorder instance and audio_stream
    var audio_context;
    var recorder;
    var audio_stream;
    var ip = window.location.href.split(":")[1].split("//")[1];

    var live_audio_stream, context;

    function goLive() {
      console.log("going live...");

      fetch("https://" + ip + ":5001/goLive");

      var mediaConstraints = {
        audio: true,
        video: false
      };

      function onMediaError(e) {
        console.error("media error", e);
      }

      function onMediaSuccess(stream) {
        var mediaRecorder = new MediaStreamRecorder(stream);
        mediaRecorder.mimeType = "audio/wav";
        mediaRecorder.bufferSize = 2048;
        mediaRecorder.recorderType = StereoAudioRecorder;
        mediaRecorder.ondataavailable = function(blob) {
          console.log(blob);
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "https://" + ip + ":5001/live", true);
          // xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
          xhr.send(blob);
        };
        mediaRecorder.start(200);
      }

      navigator.getUserMedia(mediaConstraints, onMediaSuccess, onMediaError);
    }
  </script>
</html>
